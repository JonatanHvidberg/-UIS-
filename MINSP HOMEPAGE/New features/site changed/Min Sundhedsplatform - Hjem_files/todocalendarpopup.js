$$WPUtil.guaranteeExistence($$WP,"Clinical.ToDo.Components");$$WP.Clinical.ToDo.Components.ToDoCalendarPopupComponent=function WP$Clinical$ToDo$Components$ToDoCalendarPopupComponent(b){var a=this;a.CurrentDt=b.CalendarDate||new Date;a.Month=a.CurrentDt.getMonth();a.Year=a.CurrentDt.getFullYear();a.Class=a.Class+" "+(b.Class||"todocalendar");a.Components$TemplateComponent(b);a.addEventListener("click",a._clickEvent)};$$WP.Clinical.ToDo.Components.ToDoCalendarPopupComponent.prototype={Class:"todoweekcalendar",ToolbarButtons:null,template:$$WP.Templates.Clinical.ToDoCalendarPopup,hoverTemplate:$$WP.Templates.Clinical.ToDoTile,Month:"",Year:"",CurrentDt:"",IsMouseOverTooltip:false,ShowEventDuration:true,SkipRefresh:false,setData:function setData(b){var a=this;a.Data=b;a.Components$TemplateComponent$setData(a.Data);a.ShowEventDuration=!!a.Data.ShowDuration;a.DefaultLength=30},__getEvents:function __getEvents(a){var e=a.getFullYear(),d=a.getMonth(),c=a.getDate(),b=["cal",e,d,c].join("_");return this.Data.EventDaysMap&&b in this.Data.EventDaysMap?this.Data.EventDaysMap[b].events:[]},__forEachEventInWeek:function __forEachEventInWeek(c){var a=new Date(this.CurrentDt),b=new Date(this.CurrentDt);a.setDate(a.getDate()-a.getDay());b.setDate(b.getDate()-b.getDay()+6);while(a<=b){var d=this.__getEvents(a);d.forEach(c);a.setDate(a.getDate()+1)}},__isStaticEvent:function __isStaticEvent(a){return a.AppointmentEvent.EncounterIsSurgery||a.AppointmentEvent.IsTimeToBeDetermined||a.AppointmentEvent.FormattedTime===""},__shouldDraw:function __shouldDraw(b){var a=b&&b.EventType.toLowerCase();return!(a&&(a==="healthadvisory"||a==="order"))},__getStartTime:function __getStartTime(a){var b=a.EventDateISO.match("\\d+"),c=parseInt(b[0]);return new Date(c)},__getEndTime:function __getEndTime(b){var a=this.__getStartTime(b);a.setTime(a.getTime()+b.Duration*6e4);return a},__findOverlappingEvents:function __findOverlappingEvents(c){var a=this,d=a.__getEvents(new Date(c.EventDate)),f=a.__getStartTime.bind(a),g=a.ShowEventDuration?a.__getEndTime.bind(a):$.proxy(function(b){var a=f(b);a.setMinutes(a.getMinutes()+this.DefaultLength);return a},a);d=d.filter($.proxy(function(a){return!this.__isStaticEvent(a)&&this.__shouldDraw(a)},a));for(var e=a.__groupOverlapping(d,f,g),b=0;b<e.length;b++)if(e[b].indexOf(c)!==-1)return e[b];return[c]},__groupOverlapping:function __groupOverlapping(e,d,f){e.sort(function(a,b){return d(a)-d(b)});for(var c=[],g=0;g<e.length;g++){var b=c.length&&c[c.length-1],a=e[g];if(b&&b.start<f(a)&&b.end>d(a)){b.start=Math.min(b.start,d(a));b.end=Math.max(b.end,f(a));b.intervals.push(a)}else c.push({start:d(a),end:f(a),intervals:[a]})}return c.map(function(a){return a.intervals})},setTitles:function $$WP$Clinical$ToDo$ToDoCalendarPopup$setTitles(){var n="@MYCHART@LASTDAYMONTH@",m="@MYCHART@FIRSTDAYMONTH@",l="@MYCHART@LASTDAYDATE@",k="@MYCHART@FIRSTDAYDATE@",j="@MYCHART@LASTDAYYEAR@",i="@MYCHART@FIRSTDAYYEAR@",a=this,e=a.CurrentDt,s,p,g,h,r,b,q,o,f,c=new Date(a.CurrentDt),d=new Date(a.CurrentDt);c.setDate(e.getDate()-e.getDay());d.setDate(e.getDate()-e.getDay()+6);a.Data.days=[];for(b=0;c<=d;b++){a.Data.days[b]=a.getCalendarColumnTitles(new Date(c));c.setDate(c.getDate()+1)}a.Data.numdays=7;a.Data.hours=[];for(b=0;b<24;b++){o=formatTime(makeTime(b,0,0));a.Data.hours[b]=[];a.Data.hours[b].push({hourInAmPm:o,Class:"fullhour fullhour_"+b,hour:b});a.Data.hours[b].push({hourInAmPm:"",Class:"halfhour halfhour_"+b,hour:b})}c=new Date(e);c.setDate(e.getDate()-e.getDay());q=c.getFullYear();s=d.getFullYear();g=getMonthName(c.getMonth()+1);h=getMonthName(d.getMonth()+1);p="";r="";$$WP.Strings.setDefaultNamespace("clinical.todo");$$WP.Strings.addMnemonic(i," "+c.getFullYear());$$WP.Strings.addMnemonic(j," "+d.getFullYear());$$WP.Strings.addMnemonic(k,c.getDate());$$WP.Strings.addMnemonic(l,d.getDate());$$WP.Strings.addMnemonic(m,g);$$WP.Strings.addMnemonic(n," "+h);if(c.getFullYear()===d.getFullYear())if(c.getMonth()===d.getMonth())f="weekviewheading1";else f="weekviewheading2";else f="weekviewheading";a.Data.calendarTitle=$$WP.Strings.getForTemplate(f);a.Data.previousWeekTitle=$$WP.Strings.getForTemplate("previousweektitle");a.Data.nextWeekTitle=$$WP.Strings.getForTemplate("nextweektitle");$$WP.Strings.removeMnemonic(k);$$WP.Strings.removeMnemonic(l);$$WP.Strings.removeMnemonic(i);$$WP.Strings.removeMnemonic(j);$$WP.Strings.removeMnemonic(m);$$WP.Strings.removeMnemonic(n);$$WP.Strings.clearDefaultNamespace()},__findEventDivTableCell:function __findEventDivTableCell(b){var a=this,c=a.__getStartTime(b),d=c.getDay(),f=c.getHours();if(a.__isStaticEvent(b))return a.$container.find("table#weekcalendarheadings td.day_"+d);else{var e="tr.row.fullhour_"+f+" td:nth-child("+(d+2)+")";return a.$container.find(e)}},__calculateEventDivClasses:function __calculateEventDivClasses(b){var a="event blue";return this.__isStaticEvent(b)?a+" showtime staticevent":this.ShowEventDuration?a+" showtime":a+" notime"},__calculateEventDivStyles:function __calculateEventDivStyles(b,e){var c=this,d=c.__findEventDivTableCell(b),a={};if(c.__isStaticEvent(b)){a.height=e;a.width=d.width()}else{var f=c.__findOverlappingEvents(b),i=d.outerWidth()-1,h=d.outerHeight(),g=d.position();a.width=i/f.length;a.height=c.ShowEventDuration?h*b.Duration/30-1:e;a.left=1+g.left+a.width*f.indexOf(b);a.top=1+g.top+h*c.__getStartTime(b).getMinutes()/30}return a},__createEventDiv:function __createEventDiv(a,e){var d=$$WP.SimpleTemplates.Span({"class":"clearlabel"},a.WeekViewEventAnchorTitle),b=$$WP.SimpleTemplates.Anchor({href:"#","class":this.__isStaticEvent(a)?"weekeventfocus staticeventfocus":"weekeventfocus",title:a.EventName},a.EventName);b.safeAppend(d);var f=$$WP.SimpleTemplates.Div({"class":"eventinner weekcalendarevent"},b),c=$$WP.SimpleTemplates.Div({"class":this.__calculateEventDivClasses(a)},f);c.css(this.__calculateEventDivStyles(a,e));return c},printEventDates:function $$WP$Clinical$ToDo$ToDoCalendarPopup$printEventDates(){var c="#weekevents",d="#weekcalendarevents",a=this,e=a.$container.find(d).width()-a.$container.find("#weekcalendar").width();a.$container.find(".weekheadingsdiv").css("padding-right",e+"px");a.$container.find(c).empty();var i=a.$container.find("tr.row.fullhour"),f=i.outerHeight()/30*a.DefaultLength;a.__forEachEventInWeek($.proxy(function(b){var a=this;if(!a.__shouldDraw(b))return;var e=a.__createEventDiv(b,f),g=a.__createEventTooltip(b,e),d=a.__isStaticEvent(b)?a.__findEventDivTableCell(b):a.$container.find(c);d.safeAppend(e);d.safeAppend(g)},a));var b=a.$container.find(d);if(a.$container.find(".time_8")&&b){var h=a.$container.find(".time_8").offset().top,g=b.offset().top;b.scrollTop(h-g)}},__createEventTooltip:function __createEventTooltip(h,e){var g="mouseleave",f="mouseover",b=this,i=$afe.renderTemplate(b.hoverTemplate,h),a=$$WP.SimpleTemplates.Div({"class":b.__isStaticEvent(h)?"weekcalendartooltip staticevent":"weekcalendartooltip"},i);a.addClass("hidden");var c=function(b){this.__hideTooltip(a,b)}.bind(b),d=function(){this.__showTooltip(a)}.bind(b);e.on("focusin",d);e.on(f,d);e.on(g,function(){c(300)});a.on(f,d);a.on(g,c);a.on("focusout",function(d){var b=$afe.jq(d.relatedTarget);b.length&&!b.closest(a).length&&c()});return a},__positionTooltip:function __positionTooltip(b){var a=b.prev(),i=a.width(),d=a.height(),e=a.position().left,c=a.position().top,j=this.$container.find("#weekcalendarevents"),k=j.outerHeight(),m=j.width(),g=b.outerHeight(true),h=b.outerWidth(true),f,n=e+i+h>m-15?e-h:e+i;if(a.hasClass("staticevent"))f=c+d;else{var l=$afe.select(".todoeventspopup > .content")[0].scrollTop;f=c+d+g>k+l?c-g:c+d}b.css({position:"absolute",top:f,left:Math.max(n,0),"z-index":2222,margin:"none"})},__showTooltip:function __showTooltip(a){var b=this;clearTimeout(a.attr("timeout"));b.$container.find(".weekcalendartooltip.active").each($.proxy(function(c,b){!$afe.jq(b).is(a)&&this.__hideTooltip($afe.jq(b))},b));if(a.hasClass("active"))return;a.removeClass("hidden");a.addClass("active");b.__positionTooltip(a);b.setFocus()},__hideTooltip:function __hideTooltip(a,d){var b="timeout";clearTimeout(a.attr(b));var c=$.proxy(function(){a.addClass("hidden");a.removeClass("active");a.removeAttr(b);this.setFocus()},this);if(d)a.attr(b,setTimeout(c,d));else c()},getCalendarColumnTitles:function $$WP$Clinical$ToDo$ToDoCalendarPopup$getCalendarColumnTitles(a){var d="@MYCHART@WEEKDATE@",c="@MYCHART@WEEKMONTH@",b="@MYCHART@WEEKDAYABBR@";$$WP.Strings.setDefaultNamespace("clinical.todo");$$WP.Strings.addMnemonic(b,getDayAbbr(a.getDay()));$$WP.Strings.addMnemonic(c,a.getMonth()+1);$$WP.Strings.addMnemonic(d,a.getDate());var e=$$WP.Strings.getForTemplate("weekviewcalendardayheading");$$WP.Strings.removeMnemonic(b);$$WP.Strings.removeMnemonic(c);$$WP.Strings.removeMnemonic(d);$$WP.Strings.clearDefaultNamespace();return e},show:function $$WP$Clinical$ToDo$ToDoCalendarPopup$show(){this.Components$TemplateComponent$show();this.refresh();$afe.jq(window).on("resize.toDoCalendar",$.proxy(function(){var a=this;if(isDataTile()&&a.SkipRefresh)a.SkipRefresh=false;else{a.refresh();a.SkipRefresh=true}},this))},hide:function $$WP$Clinical$ToDo$ToDoCalendarPopup$hide(){$afe.jq(window).off("resize.toDoCalendar")},setFocus:function setFocus(){var a=this;a.ContainerComponent&&a.ContainerComponent.ContainerComponent&&typeof a.ContainerComponent.ContainerComponent.setFocus==="function"&&a.ContainerComponent.ContainerComponent.setFocus()},refresh:function $$WP$Clinical$ToDo$ToDoCalendarPopup$refresh(){var a=this;if($afe.select(".todoweekcalendar .todoweekcalendarcontent").hasClass("hidden"))return;a.setTitles();a.Components$TemplateComponent$refresh();a.printEventDates();a.setFocus()},html:function $$WP$Clinical$ToDo$ToDoCalendarPopup$html(a){this.Components$TemplateComponent$html(a)},_clickEvent:function $$WP$Clinical$ToDo$ToDoCalendarPopup$_clickEvent(b){var a=this;if(b)if(b.dataId==="previousweek"){a.CurrentDt.setDate(a.CurrentDt.getDate()-7);a.refresh();a.ContainerComponent.ContainerComponent.setFocus();a.$content.find(".nextweekbuttons li.previousweek a").focus();return false}else if(b.dataId==="nextweek"){a.CurrentDt.setDate(a.CurrentDt.getDate()+7);a.refresh();a.ContainerComponent.ContainerComponent.setFocus();a.$content.find(".nextweekbuttons li.nextweek a").focus();return false}}};$$WP.Clinical.ToDo.Components.ToDoCalendarPopupComponent.extend("Components.TemplateComponent")