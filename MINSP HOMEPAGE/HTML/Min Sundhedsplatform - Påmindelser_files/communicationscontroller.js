(function ClassDefinition(){var n="otherbutton",j="Preferences/Communications/SetSms",g="nextstep",m="#contact-information-container .editButton",i="sticky",l=".tabletitle",c="hidden",f="#savebutton",e=null,b=true,a=false,k="#contact-information-container",d="Preferences.Communications";$$WP.Utilities.guaranteeExistence($$WP,d);var h=function CommunicationsController(e,i,n){var g="#inputForm",c=this;c.WP$Controllers$Controller();c.ConceptViewBinder=new $$WP.Preferences.Communications.ConceptViewBinder;c.ConceptViewBinder.setBindingRoot(i.find(g));c.ConceptGroupViewBinder=new $$WP.Preferences.Communications.ConceptGroupViewBinder;c.ConceptGroupViewBinder.setBindingRoot(i.find(g));c._setupSettings(e);for(var f=0;f<e.ConceptGroups.length;f++){var m=new $$WP.Preferences.Communications.ConceptGroup(e.ConceptGroups[f],c.ConceptViewBinder,c);c.ConceptGroupViewBinder.bind(m,$afe.select("#hst_"+m.BindingId));for(var h=0;h<e.ConceptGroups[f].Concepts.length;h++){var l=$afe.select("#hst_infobubble_"+e.ConceptGroups[f].Concepts[h].BindingId);if(l.length>0){var o=new $$WP.UI.InfoBubble($$WP.UI.InfoBubble.SimpleInfoBubble(e.ConceptGroups[f].Concepts[h].Description));l.empty().safeAppend($afe.renderTemplate($$WP.Templates.UI.InfoBubble,o))}}}c.proxify("_onSaveButtonClick","_setupHeader","_smsKillSwitchClicked","_smsSignupFormClicked","_stickHeader","_setContactInformationFocus","_showAfterSavingWarningMessagesCallBack","_showContactAlertIfNeeded");c._$viewContainer=i;var j=$afe.select(k);if(j.length>0){var d=new $$WP.PersonalInformation.ContactInformationSettings;d.onEditClickedCallback=c._setContactInformationFocus;d.onSaveSuccessCallback=c._showContactAlertIfNeeded;d.onLoadSuccessCallback=c._showContactAlertIfNeeded;d.focusOnLoad=a;d.useLoginUserEpt=n;d.disableRTL=b;c._contactInformationController=new $$WP.PersonalInformation.ContactInformationController(j,d)}c._setupHeader();c._attachHandlers()};h.Errors={BillingRequired:1};h.Warnings={MissingEmailAddress:1,MissingCellPhoneNumber:2,MissingPhoneNumber:3,MissingMailingAddress:4};h.MediaEnum={Email:"1",Mail:"3",Phone:"4",Text:"100"};h.prototype={ConceptViewBinder:e,ConceptGroupViewBinder:e,_contactInformationController:e,_$viewContainer:e,_isBillingConceptsRequired:e,_smsFlagOn:e,_userAcceptsSms:e,_warnings:[],_warningsPopupObject:e,PaperlessRequiredConcepts:[],_forcePaperlessEmailSignup:a,showHideSaveButton:function showHideSaveButton(h){var g="#confirmsave",e=".applytoalldiv",d="disabled";if(this._forcePaperlessEmailSignup)return;if(h){$afe.select(f).removeClass(c).prop(d,a);$afe.select(e).removeClass(c);$afe.select(g).addClass(c);WP.Events.beforeUnload()}else{$afe.select(g).removeClass(c).focus();$afe.select(f).addClass(c).prop(d,b);$afe.select(e).addClass(c);WP.Events.cancelBeforeUnload()}},_setupHeader:function setupHeader(){var a,b;a=$afe.select(".mediaheader");$afe.select(l).removeClass(i);b=a.offset().left;a.css("left",b);this._stickHeader()},_stickHeader:function stickHeader(){var a=".tableform";if(!$afe.select("body").hasClass("scrollDisabled")&&!isDataTile()){var d=$afe.select("#header").height(),e=$$WPUtil.getScrollTop(),b=$afe.select(l),f=$afe.select(a).offset().top,g=$afe.select(a).height();if(e>f-d)b.addClass(i);else b.removeClass(i);if(e>f+g-d)b.addClass(c);else b.removeClass(c)}},_setupSettings:function setupSettings(a){this._isBillingConceptsRequired=a.PaperlessBillingEnabled&&a.BillingConceptsRequired;this._smsFlagOn=a.SmsFlagOn;this._userAcceptsSms=a.UserAcceptsSms},_attachHandlers:function _attachHandlers(){var b="click",a=this;a._$viewContainer.on(b,f,a._onSaveButtonClick);a._$viewContainer.on(b,"#smsSignupFormPopup",a._smsSignupFormClicked);a._$viewContainer.on(b,"#editContact",a._onContactAlertClick);$afe.select("#sidebar").on(b,"#smsKillSwitchPopup",a._smsKillSwitchClicked);$afe.jq(window).on("scroll",a._stickHeader);$afe.jq(window).on("resize",a._setupHeader)},_onContactAlertClick:function onContactAlertClick(a){$$WPUtil.SmoothScrollToElement($$WPUtil.ScrollableBody(),$afe.select(k));$afe.select(m).click();a.preventDefault()},_onSaveButtonClick:function onSaveButtonClick(){var e=this;for(var h=[],d,k,j=e.ConceptViewBinder.getBoundModels(),i=a,g=0;g<j.length;g++){d=j[g];if(e._isBillingConceptsRequired)if(d.IsRequiredByPaperless)if(!d.isSubscribed()){k=b;e._showSaveUnsuccessfulPopup([$$WP.Preferences.Communications.Controller.Errors.BillingRequired]);return}h.push(d.getSimplifyModel())}i=$afe.select("#applytoall").is(":checked");$afe.select(f).addClass(c);$.ajax({context:e,url:makeLink("Preferences/Communications/Save"),type:"POST",cache:a,data:{savedPreference:JSON.stringify(h),applyToAll:i},dataType:"json",success:function(c){var b=this;if(!c)b._showSaveUnsuccessfulPopup();else{b._showContactAlertIfNeeded();b.showHideSaveButton(a);b._warnings.length>0&&b._showAfterSavingWarningMessages()}}})},_generateListOfWarnings:function _generateListOfWarnings(){var a=this,b,f,d=[],g=a.ConceptViewBinder.getBoundModels();if(!a._contactInformationController||!a._contactInformationController.ViewModel)return;else b=a._contactInformationController.ViewModel;a._warnings=[];for(var e=0;e<g.length;e++){f=g[e];d=f.appendToListOfSubscribedMedia(d)}for(var c in d)if(c===$$WP.Preferences.Communications.Controller.MediaEnum.Text)b.MobilePhone.length===0&&a._warnings.push($$WP.Preferences.Communications.Controller.Warnings.MissingCellPhoneNumber);else if(c===$$WP.Preferences.Communications.Controller.MediaEnum.Email)b.Email.length===0&&a._warnings.push($$WP.Preferences.Communications.Controller.Warnings.MissingEmailAddress);else if(c===$$WP.Preferences.Communications.Controller.MediaEnum.Phone)b.MobilePhone.length===0&&b.HomePhone.length===0&&b.WorkPhone.length===0&&a._warnings.push($$WP.Preferences.Communications.Controller.Warnings.MissingPhoneNumber);else if(c===$$WP.Preferences.Communications.Controller.MediaEnum.Mail)b.PermanentAddress.FormattedValues.length===0&&a._warnings.push($$WP.Preferences.Communications.Controller.Warnings.MissingMailingAddress)},_showAfterSavingWarningMessages:function showAfterSavingWarningMessages(){var e=this,i,h,k,c,j,f;i=$$WP.Strings.getNamespace(d);if(e._warnings&&e._warnings.length>0){c=document.createElement("div");f=document.createElement("div");f.className="bold warningmessage";$$WP.Strings.setDisplayText(f,"WarningPopupTextTitle",d);j=f.outerHTML;for(h=0;h<e._warnings.length;h++){k=e._warnings[h];switch(k){case $$WP.Preferences.Communications.Controller.Warnings.MissingCellPhoneNumber:$$WP.Strings.setDisplayText(c,"MissingCellPhoneNumberPopupText",d);break;case $$WP.Preferences.Communications.Controller.Warnings.MissingEmailAddress:$$WP.Strings.setDisplayText(c,"MissingEmailAddressPopupText",d);break;case $$WP.Preferences.Communications.Controller.Warnings.MissingMailingAddress:$$WP.Strings.setDisplayText(c,"MissingMailPopupText",d);break;case $$WP.Preferences.Communications.Controller.Warnings.MissingPhoneNumber:$$WP.Strings.setDisplayText(c,"MissingPhoneNumberPopupText",d)}j+=c.outerHTML}e._warningsPopupObject=$$WPUtil.quickPopup(new $$WPComp.ConfirmComponent({callback:e._showAfterSavingWarningMessagesCallBack,ToolbarButtons:[{Text:i.getStringForTemplate("PopupEditPersonalInformationButton"),Class:g},{Text:i.getStringForTemplate("PopupCancelButton")}],Html:j,AffirmButtonIndex:0,TitleText:i.getString("SaveChangesUnsucessfulWithWarningsPopupHeader"),forcePrompt:b,IsClosable:b}),{Size:$$WP.Containers.Popup.SizeEnum.SMALL,HasBackButton:a})}},_showAfterSavingWarningMessagesCallBack:function showAfterSavingWarningMessagesCallBack(a){if(a){this._warningsPopupObject.dispose();$afe.select(m).click()}},_setContactInformationFocus:function contactInformationFocus(){var a;if(this._warnings.length>0){a=this._warnings[0];switch(a){case $$WP.Preferences.Communications.Controller.Warnings.MissingCellPhoneNumber:$afe.select("#ContactInformation_MobilePhone").focus();break;case $$WP.Preferences.Communications.Controller.Warnings.MissingEmailAddress:$afe.select("#ContactInformation_Email").focus();break;case $$WP.Preferences.Communications.Controller.Warnings.MissingMailingAddress:$afe.select("#PermanentAddress_Street").focus();break;case $$WP.Preferences.Communications.Controller.Warnings.MissingPhoneNumber:$afe.select("#ContactInformation_HomePhone").focus()}}},_showSaveUnsuccessfulPopup:function showSaveUnsuccessfulPopup(i){var h="@MYCHART@REQUIREDTICKLER2@",f=this,c,l,p,j,m,n,e,k,o;c=$$WP.Strings.getNamespace(d);k=f.PaperlessRequiredConcepts[0].ParentGroup;if(i&&i.length>0){n=c.getString("SaveChangesUnsucessfulWithErrorsPopupHeader");for(j=0;j<i.length;j++){p=i[j];switch(p){case $$WP.Preferences.Communications.Controller.Errors.BillingRequired:for(e=0;e<f.PaperlessRequiredConcepts.length;e++)c.addMnemonic("@MYCHART@REQUIREDTICKLER"+(e+1)+"@",f.PaperlessRequiredConcepts[e].Title);f.PaperlessRequiredConcepts.length===1&&c.addMnemonic(h," ");l=document.createElement("div");$$WP.Strings.setDisplayText(l,"RequiredTicklersPopupText",d);m=l.outerHTML;c.removeMnemonic("@MYCHART@REQUIREDTICKLER1@",d);c.removeMnemonic(h,d);k.setProperty("Expanded",1)}}}else{n=c.getString("SaveChangesUnsuccesfulPopupHeader");m=c.getString("SaveChangesUnsuccesfulPopupText")}o=$$WPUtil.quickPopup(new $$WPComp.ConfirmComponent({callback:function(){return},TitleText:n,ToolbarButtons:[{Text:c.getStringForTemplate("PopupAcceptButton"),Class:g}],Html:m,AffirmButtonIndex:0,forcePrompt:b,IsClosable:b}),{Size:$$WP.Containers.Popup.SizeEnum.SMALL,HasBackButton:a});o.FocusOnClose=f.ConceptGroupViewBinder.getBoundElements(k).find(".groupitem .leftcolumn")},_switchSMSFlag:function switchSMSFlag(){var h="IsSmsOff",g="#smsSignupForm",f=".smsKillSwitch",d=this,l,k,j,e,i;if(d._userAcceptsSms){$afe.select(f).removeClass(c);d._$viewContainer.find(g).addClass(c)}else{$afe.select(f).addClass(c);d._$viewContainer.find(g).removeClass(c)}k=d.ConceptGroupViewBinder.getBoundModels();for(e=0;e<k.length;e++){l=k[e];l.setProperty(h,!d._userAcceptsSms)}j=d.ConceptViewBinder.getBoundModels();for(e=0;e<j.length;e++){i=j[e];i.setProperty(h,!d._userAcceptsSms);if(!d._userAcceptsSms)if(i.IsRequiredByPaperless){d._forcePaperlessEmailSignup=b;i.setProperty("Medias",$$WP.Preferences.Communications.Concept.preferenceType.Approved,$$WP.Preferences.Communications.Controller.MediaEnum.Email);d._forcePaperlessEmailSignup=a}}d._showContactAlertIfNeeded()},_smsSignupFormClicked:function smsSignupFormClicked(){var e,c;e=$$WP.Strings.getNamespace(d);c=this;$$WPUtil.quickPopup(new $$WPComp.ConfirmComponent({callback:function(a){a&&$.post(makeLink(j),{UserAcceptsSms:b},function(a){if(a==="True"){c._userAcceptsSms=b;c._switchSMSFlag()}else c._showSaveUnsuccessfulPopup()}).fail(c._showSaveUnsuccessfulPopup)},TitleText:e.getString("SmsSignupPopupHeader"),ToolbarButtons:[{Text:e.getStringForTemplate("SmsSignupPopupAcceptButton"),Class:g},{Text:e.getStringForTemplate("SmsSignupPopupCancelButton"),Class:n}],Html:e.getString("SmsSignupPopupText"),AffirmButtonIndex:0,forcePrompt:b,IsClosable:b}),{Size:$$WP.Containers.Popup.SizeEnum.MEDIUM,HasBackButton:a});return a},_smsKillSwitchClicked:function smsKillSwitchClicked(){var c,e;c=$$WP.Strings.getNamespace(d);e=this;var f=c.getString("KillSwitchPopupText");if(this._isBillingConceptsRequired)f+="<br />"+c.getString("KillSwitchPopupPaperlessBillingText");$$WPUtil.quickPopup(new $$WPComp.ConfirmComponent({callback:function(b){b&&$.post(makeLink(j),{UserAcceptsSms:a},function(b){if(b==="True"){e._userAcceptsSms=a;e._switchSMSFlag()}else e._showSaveUnsuccessfulPopup()}).fail(e._showSaveUnsuccessfulPopup)},TitleText:c.getString("KillSwitchPopupHeader"),ToolbarButtons:[{Text:c.getStringForTemplate("KillSwitchPopupAcceptButton"),Class:g},{Text:c.getStringForTemplate("KillSwitchPopupCancelButton"),Class:n}],Html:f,AffirmButtonIndex:0,forcePrompt:b,IsClosable:b}),{Size:$$WP.Containers.Popup.SizeEnum.MEDIUM,HasBackButton:a});return a},_showContactAlertIfNeeded:function showContactAlertIfNeeded(){var a="#contactAlert",b=this;if(!b._contactInformationController)return;b._generateListOfWarnings();if(b._warnings&&b._warnings.length>0)$afe.select(a).removeClass(c);else $afe.select(a).addClass(c)}};$$WP.Preferences.Communications.Controller=h;h.extend($$WP.Controllers.Controller,"WP$Preference$Communications$Controller")})();$$WP.Debug.UnitTest=$$WP.Debug.UnitTest||{};$$WP.Debug.UnitTest.tests=$$WP.Debug.UnitTest.tests||[];$$WP.Debug.UnitTest.tests.push(function UnitTests$CommunicationsController(){var a;a=$$WP.Debug.UnitTest.assert})