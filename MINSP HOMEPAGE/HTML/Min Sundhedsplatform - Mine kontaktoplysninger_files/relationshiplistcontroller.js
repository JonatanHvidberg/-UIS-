(function ClassDefinition(){var j="disabled",i=".saveButton",h=".relationship-content",y="cardLoad",x="WorkPhone",w="MobilePhone",v="HomePhone",n=".loadingIndicator",f="json",e="POST",u=".primary-contact-checkbox",t=".name.header .primaryContactLabel",g="Relationship_",b=true,d="']",s="[model-id='",m="_Name",l="model-id",k="[model-id]",a=false,c=null,p=".cardlist.matchHeights",r=".preferredDeviceSelector";$$WP.Utilities.guaranteeExistence($$WP,"Demographics.Relationships.Controllers");var A="NewModel",q=$$WP.Controllers.EditableListViewController,o=$$WP.Demographics.Relationships.Models,s_getFieldIdFromErrorIndex,s_onAddressLoadStart,s_onAddressLoadEnd,z=function RelationshipListController(e,c,b,d,f){var a=this;c=c||$$WP.Templates.Relationships.Relationship;b=b;a.__disableRTL=f;a.WP$Controllers$EditableListViewController(e,c,b,d);a.proxify("_onPreferredDeviceSelectorClicked","_afterAddressRender");a._$viewContainer.on("click",r,a._onPreferredDeviceSelectorClicked);a._$viewContainer.on("input change focusout",function(){$afe.select(p).each($$WP.Utilities.UI.Cards.MatchHeights)})},B={SharedData:{},OrderedRelationshipList:c,_addressControllerList:c,__disableRTL:a,onCancelButtonClicked:function onCancelButtonClicked(e){var d,b,a;d=$afe.jq(e.currentTarget);b=d.parents(k);a=$$WP.Common.Model.getInstance(b.safeAttr(l));a&&this._addressControllerList[a.ModelId].setViewModel(a.AddressViewModel);q.prototype.onCancelButtonClicked.call(this,e);if(a!==undefined&&a!==c)$afe.select("#"+a.ModelId+m).focus();else $afe.select("[model-id='NewModel'] a").focus()},onAddButtonClicked:function onAddButtonClicked(a){this.WP$Controllers$EditableListViewController$onAddButtonClicked(a);$afe.select("#NewRelationshipFirstName").focus()},onEditButtonClicked:function onEditButtonClicked(e){var b,a,f;b=$afe.jq(e.currentTarget);a=b.parents(k);f=$$WP.Common.Model.getInstance(a.safeAttr(l));this.WP$Controllers$EditableListViewController$onEditButtonClicked(e);var c=$afe.select(s+f.ModelId+d);c.length>0&&$afe.jq(WP.DOM.Search.getNextFocusable(c[0])).focus()},_onLoadSuccess:function _onLoadSuccess(a){this._parseData(a);if(!a.HasConversionToEPT1733Run)this._addTemplate=c;if(a.HideRelationships){$afe.select(".relationship-section,.end-of-life-quicklink").remove();return}this.renderModelCollection()},_parseData:function _parseData(d){var a=this,e;a.ModelCollection=new $$WP.Common.ModelCollection([],[],[]);a.ModelCollection.addRange(o.Relationship.parseList(d.Relationships));a.OrderedRelationshipList=a.ModelCollection.Models.slice();a.SharedData.AddressConfiguration=d.AddressConfiguration;a.SharedData.CategoryData=d.CategoryData;a.SharedData.ProxyContextName=d.ProxyContextName;a.SharedData.RequiredFieldList=d.RequiredFields;a.SharedData.VRKFieldNames={};a.SharedData.RequiredFieldNames={};a.SharedData.RequiredFieldNamesForVRK={};for(vrkIdx in d.VRKFields)a.SharedData.VRKFieldNames[d.VRKFields[vrkIdx]]=b;for(e in d.RequiredFields){a.SharedData.RequiredFieldNames[d.RequiredFields[e]]=b;if(!a.SharedData.VRKFieldNames[d.RequiredFields[e]])a.SharedData.RequiredFieldNamesForVRK[d.RequiredFields[e]]=b}a.SharedData.Validation=a._setUpRelationshipFormValidationObjects(a.SharedData.RequiredFieldNames);a._addressControllerList=[];a.ModelCollection.Models.forEach($.proxy(function(b){var a=this;a.setUpSharedDataForModel(b);a._addressControllerList[b.ModelId]=new $$WP.PersonalInformation.AddressController(g+b.ModelId,b.AddressViewModel,a.SharedData.AddressConfiguration,a.SharedData.RequiredFieldList,c,a.__disableRTL,b.IsVRK?a.SharedData.VRKFieldNames:c);a._addressControllerList[b.ModelId].afterRender=a._afterAddressRender;a._addressControllerList[b.ModelId].onDataLoadStart=s_onAddressLoadStart;a._addressControllerList[b.ModelId].onDataLoadEnd=s_onAddressLoadEnd}),a)},_onSaveExistingModelSuccess:function _onSaveExistingModelSuccess(g,n){var d=this,c,h,f,e,i,j,k,l;c=$$WP.Common.Model.getInstance(n);k=[c];if(g.Success){f=o.Relationship.prototype.s_dataMembers;for(e=0;e<f.length;e++){if(f[e]==="IsViewOnly"||f[e]==="IsPrivate"||f[e]==="IsActiveHealthCareAgent")continue;c.setProperty(f[e],g.ViewModel[f[e]])}d.setUpSharedDataForModel(c);c.IsDeletePending=a;c.IsUpdatePending=a;c.IsAddPending=a;if(c.IsPrimary){if(d.OrderedRelationshipList[0]!==c)i=d.OrderedRelationshipList[0];d._setAsPrimaryRelationship(c)}if(i){d.getModelViewContainer(c).remove();d.numberOfEditModels--;c.DisplayEditable=a;d._$viewContainer.safePrepend($afe.renderTemplate(d._template,c));j=d.getModelViewContainer(i);j.find(t).remove();i.DisplayEditable&&j.find(u).removeClass("hidden")}else d.renderModel(c,a)}else if(g.ViewModel.ValidationErrors){h=o.Relationship.parse(g.ViewModel);h.ModelId=c.ModelId;h.DisplayEditable=b;d.setUpSharedDataForModel(h);d.renderModel(h,b);for(e=0;e<g.ViewModel.ValidationErrors.length;e++){l=$afe.select(s_getFieldIdFromErrorIndex(g.ViewModel.ValidationErrors[e].ErrorIndex,h.ModelId));$$WP.FormValidation.addValidationError(l,g.ViewModel.ValidationErrors[e].ErrorKey)}}else{d.setUpSharedDataForModel(c);d._addressControllerList[c.ModelId].setViewModel(c.AddressViewModel);c.IsDeletePending=a;c.IsAddPending=a;c.IsUpdatePending=b;d.renderModel(c,a)}d.afterRender(k);$afe.select("#"+c.ModelId+m).focus()},_onSaveNewModelSuccess:function _onSaveNewModelSuccess(e){var a=this,d,h,i,f,j;if(e.Success){d=o.Relationship.parse(e.ViewModel);a.ModelCollection.add(d);a.setUpSharedDataForModel(d);a._addressControllerList[d.ModelId]=new $$WP.PersonalInformation.AddressController(g+d.ModelId,d.AddressViewModel,a.SharedData.AddressConfiguration,a.SharedData.RequiredFieldList,a.__disableRTL);a._addressControllerList[d.ModelId].afterRender=a._afterAddressRender;a._addressControllerList[d.ModelId].onDataLoadStart=s_onAddressLoadStart;a._addressControllerList[d.ModelId].onDataLoadEnd=s_onAddressLoadEnd;if(d.IsPrimary){if(a.OrderedRelationshipList.length)h=a.OrderedRelationshipList[0];a._setAsPrimaryRelationship(d)}a.getModelViewContainer(c).remove();a.numberOfEditModels--;if(d.IsPrimary){a._$viewContainer.safePrepend($afe.renderTemplate(a._template,d));if(h){i=a.getModelViewContainer(h);i.find(t).remove();h.DisplayEditable&&i.find(u).removeClass("hidden")}}else a._$viewContainer.safeAppend($afe.renderTemplate(a._template,d));a._$viewContainer.safeAppend($afe.renderTemplate(a._addTemplate,{}));a.afterEachRender(d);$afe.select("#"+d.ModelId+m).focus()}else{d=o.Relationship.parse(e.ViewModel);d.ModelId=e.ViewModel.ModelId;d.DisplayEditable=b;a.setUpSharedDataForModel(d);d.DisplayEditable=b;a.getModelViewContainer(d).safeReplaceWith($afe.renderTemplate(a._addTemplate,d));a.afterEachRender(d);if(e.ViewModel.ValidationErrors)for(f=0;f<e.ViewModel.ValidationErrors.length;f++){j=$afe.select(s_getFieldIdFromErrorIndex(e.ViewModel.ValidationErrors[f].ErrorIndex,d.ModelId));$$WP.FormValidation.addValidationError(j,e.ViewModel.ValidationErrors[f].ErrorKey)}else a.getModelViewContainer(d).find(".addFail").show()}a.afterRender([d])},_onRemoveModelSuccess:function _onRemoveModelSuccess(g,f){var c=this,d,e;d=$$WP.Common.Model.getInstance(f);c.setUpSharedDataForModel(d);if(g.Success||d.IsAddPending){if(c.OrderedRelationshipList.length>1&&c.OrderedRelationshipList[0]===d){e=c.OrderedRelationshipList[1];e.IsPrimary=b}c.ModelCollection.remove(d);c.OrderedRelationshipList.splice(c.OrderedRelationshipList.indexOf(d),1);c.getModelViewContainer(d).remove();e&&c.renderModel(e,e.DisplayEditable)}else{d.IsUpdatePending=a;d.IsAddPending=a;d.IsDeletePending=b;c.renderModel(d,a)}c.afterRender();$afe.select("#relationship-header").focus()},_onPreferredDeviceSelectorClicked:function _onPreferredDeviceSelectorClicked(i){var h="[name='PreferredDevice']",e="checked",d="selected",c="input",f,g;f=$afe.jq(i.currentTarget);g=f.parents(k);!$afe.jq(i.target).is(c)&&i.preventDefault();if(f.hasClass(d)){f.removeClass(d).find(c).prop(e,a);g.find(h).val("")}else{g.find(r).removeClass(d).find(c).prop(e,a);f.addClass(d);g.find(h).val(f.find(c).prop(e,b).val())}this._setPreferredDeviceToBeRequired(g)},loadData:function loadData(){$.ajax({type:e,url:makeLink("Demographics/Relationships/GetRelationshipList"),dataType:f,success:$.proxy(this._onLoadSuccess,this)})},saveExistingModel:function saveExistingModel(h,d){var c=this,a,g;g=c;d.find(n).show();a=$.extend(b,{},h.toRawObject());a.setCategoryTitles=h.setCategoryTitles;c._getPropertiesForExistingViewModel(a,d);a.disableRTL=c.__disableRTL;c._prepModelForPOST(a);$.ajax({type:e,url:makeLink("Demographics/Relationships/UpdateRelationship"),data:$$WPUtil.postify(a),dataType:f,success:function(b){g._onSaveExistingModelSuccess(b,a.ModelId)}})},saveNewModel:function saveNewModel(c){var a=this,b={ModelId:A};c.find(n).show();a._getPropertiesForNewViewModel(b,c);b.disableRTL=a.__disableRTL;a._prepModelForPOST(b);$.ajax({type:e,url:makeLink("Demographics/Relationships/CreateRelationship"),data:$$WPUtil.postify(b),dataType:f,success:$.proxy(a._onSaveNewModelSuccess,a)})},removeModel:function removeModel(a,b){var c=this;b.find(n).show();this._prepModelForPOST(a);$.ajax({type:e,url:makeLink("Demographics/Relationships/TerminateRelationship"),data:$$WPUtil.postify(a),dataType:f,success:function(b){c._onRemoveModelSuccess(b,a.ModelId)}})},_getPropertiesForNewViewModel:function getPropertiesForNewViewModel(a,b){a.FirstName=b.find("[name='RelationshipFirstName']").val()||c;a.LastName=b.find("[name='RelationshipLastName']").val()||c;a.FormattedName=a.FirstName+" "+a.LastName;this._getPropertiesForExistingViewModel(a,b)},_getPropertiesForExistingViewModel:function getPropertiesForExistingViewModel(a,b){a.ModelId=b.safeAttr(l)||c;a.AddressViewModel=this._addressControllerList[a.ModelId].getViewModel();if(!a.IsPrimary)a.IsPrimary=b.find("[name='PrimaryContactButtonCheckbox']").is(".checked");this._getGenericFieldsForExistingViewModel(a,b)},_getGenericFieldsForExistingViewModel:function _getGenericFieldsForExistingViewModel(a,b){$$WP.Utilities.guaranteeExistence(a,"RelationToPatient.Value");a.RelationToPatient.Value=b.find("[name='RelationshipType']").val()||c;$$WP.Utilities.guaranteeExistence(a,"HomePhone.Value");a.HomePhone.Value=b.find("input[name='HomePhone']").val()||c;$$WP.Utilities.guaranteeExistence(a,"WorkPhone.Value");a.WorkPhone.Value=b.find("input[name='WorkPhone']").val()||c;$$WP.Utilities.guaranteeExistence(a,"MobilePhone.Value");a.MobilePhone.Value=b.find("input[name='MobilePhone']").val()||c;$$WP.Utilities.guaranteeExistence(a,"PreferredDevice.Value");a.PreferredDevice.Value=b.find("input[name='PreferredDevice']").val()||c;$$WP.Utilities.guaranteeExistence(a,"Email.Value");a.Email.Value=b.find("input[name='Email']").val()||c},createBlankModel:function createBlankModel(){var b=this,d={ModelId:A,IsVRK:a};b.setUpSharedDataForModel(d);b._addressControllerList[d.ModelId]=new $$WP.PersonalInformation.AddressController(g+d.ModelId,c,b.SharedData.AddressConfiguration,b.SharedData.RequiredFieldList,b._afterAddressRender,b.__disableRTL);b._addressControllerList[d.ModelId].afterRender=b._afterAddressRender;b._addressControllerList[d.ModelId].onDataLoadStart=s_onAddressLoadStart;b._addressControllerList[d.ModelId].onDataLoadEnd=s_onAddressLoadEnd;return d},_setAsPrimaryRelationship:function _setAsPrimaryRelationship(d){var c=this,e=c.OrderedRelationshipList.indexOf(d);if(e===-1){c.OrderedRelationshipList.unshift(d);if(c.OrderedRelationshipList.length>1)c.OrderedRelationshipList[1].IsPrimary=a;return}if(d===c.OrderedRelationshipList[0])return;c.OrderedRelationshipList[0].IsPrimary=a;c.OrderedRelationshipList.splice(c.OrderedRelationshipList.indexOf(d),1);c.OrderedRelationshipList.unshift(d);c.OrderedRelationshipList[0].IsPrimary=b},setUpSharedDataForModel:function setUpSharedDataForModel(a){var e="RequiredFieldNames",d=this;$$WP.Utilities.guaranteeExistence(a,"RelationToPatient.CategoryItems",d.SharedData.CategoryData[1e3].CategoryItems);$$WP.Utilities.guaranteeExistence(a,"LegalRelationToPatient.CategoryItems",d.SharedData.CategoryData[1107].CategoryItems);$$WP.Utilities.guaranteeExistence(a,"PendingLegalRelationToPatient.CategoryItems",d.SharedData.CategoryData[1113].CategoryItems);$$WP.Utilities.guaranteeExistence(a,"setCategoryTitles",o.Relationship.prototype.setCategoryTitles);a.setCategoryTitles();a.ProxyContextName=d.SharedData.ProxyContextName;if(a.LegalRelationToPatient&&a.LegalRelationToPatient.Value!==c&&a.LegalRelationToPatient.Value!==""||a.PendingLegalRelationToPatient&&a.PendingLegalRelationToPatient.Value!==c&&a.PendingLegalRelationToPatient.Value!=="")a.IsHCA=b;if(a.IsVRK){$$WP.Utilities.guaranteeExistence(a,e,d.SharedData.RequiredFieldNamesForVRK);$$WP.Utilities.guaranteeExistence(a,"VRKFieldNames",d.SharedData.VRKFieldNames)}else $$WP.Utilities.guaranteeExistence(a,e,d.SharedData.RequiredFieldNames);$$WP.Utilities.guaranteeExistence(a,"Validation",d.SharedData.Validation)},_setUpRelationshipFormValidationObjects:function _setUpFormValidationObjects(a){var c={};a=a||{};c.Required=$$WP.FormValidation.ValidationSettings.Required;c.Email=new $$WP.FormValidation.ValidationSettings({isEmail:b,required:a.Email});return c},_prepModelForPOST:function _prepModelForPOST(a){delete a.Validation;delete a.setCategoryTitles;if(typeof a.RelationToPatient!=="undefined")delete a.RelationToPatient.CategoryItems;delete a.LegalRelationToPatient;delete a.PendingLegalRelationToPatient;delete a.LinkedDocumentId;delete a.PendingLinkedDocumentId},getModelViewContainer:function getModelViewContainer(a){var b;if(a&&a.ModelId&&a.ModelId!=="")b=a.ModelId;else b=A;return this._$viewContainer.find(s+b+d)},getOrderedCollection:function getOrderedCollection(){return this.OrderedRelationshipList},_setPreferredDeviceToBeRequired:function _setPreferredDeviceToBeRequired(g){var f,h,c,e;h=[v,w,x];h.forEach($.proxy(function(i){var h="input[name='";if(!this.SharedData.RequiredFieldNames[i]){if(g)f=g.find(h+i+d);else f=this._$viewContainer.find(h+i+d);f.each(function(l,k){var j="aria-required",h="required",g="label[data-name='",f="data-validation-settings";c=$afe.jq(k);if(c.siblings(".preferredDeviceSelector.selected").length){e=new $$WP.FormValidation.ValidationSettings($.parseJSON(c.safeAttr(f)||"{}"));e.required=b;c.siblings(g+i+d).addClass(h);c.safeAttr(f,e.toJSON()).safeAttr(j,b).change()}else{e=new $$WP.FormValidation.ValidationSettings($.parseJSON(c.safeAttr(f)||"{}"));e.required=a;c.siblings(g+i+d).removeClass(h);c.safeAttr(f,e.toJSON()).safeAttr(j,a).change()}})}}),this)},afterEachRender:function afterEachRender(a){var c=this,b=c.getModelViewContainer(a);if($$WP.Utilities.UI.IsMobile&&a.DisplayEditable){b.find(".formbuttons").removeClass("buttonList right");b.removeClass("withButton")}c._renderAddress(b,a);(a.IsUpdatePending||a.IsDeletePending||a.IsAddPending)&&c.getModelViewContainer(a).find(".saveFail").show();setupButtoncheck(b);c._setPreferredDeviceToBeRequired(b);q.prototype.afterEachRender.call(c,a)},_renderAddress:function _renderAddress(a,b){this._addressControllerList[b.ModelId].renderTo(a.find(".relationshipAddress"))},afterRender:function afterRender(c){var a=this;a._$viewContainer.trigger(y);a._$viewContainer.find(".hideLongContentWithEllipses").each(function(){if(this.getClientRects().length>1){var a=$afe.jq(this);a.addClass("overflowHiddenWithEllipses").safeAttr("title",a.text())}});q.prototype.afterRender.call(a,c);a._$viewContainer.find(".addressContainer .loadingIndicator").each(function(){$afe.jq(this).parents(h).find(i).prop(j,b)})},_afterAddressRender:function afterAddressRender(){this.afterRender();this._$viewContainer.trigger(y)}};s_getFieldIdFromErrorIndex=function s_getFieldIdFromErrorIndex(b,c){var a="#Relationship_";switch(b){case"Address.Zip":return a+c+"_Zip";case v:case w:case x:return a+c+"_"+b}return""};s_onAddressLoadStart=function s_onAddressLoadStart(){this.$root.parents(h).find(i).prop(j,b)};s_onAddressLoadEnd=function s_onAddressLoadEnd(){this.$root.parents(h).find(i).prop(j,a);this.$root.parent(p).each($$WP.Utilities.UI.Cards.MatchHeights)};z.prototype=B;$$WP.Demographics.Relationships.Controllers.RelationshipListController=z;z.extend(q,"WP$Demographics$Relationships$Controllers$RelationshipListController")})()