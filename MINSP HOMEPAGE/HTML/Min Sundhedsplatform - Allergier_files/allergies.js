/*! Copyright (c) Epic Systems Corporation 2017-2018 */
$$WPUtil.guaranteeExistence($$WP,"Clinical.Allergies.Components");$$WP.Clinical.Allergies.Components.Allergies=function $$WP$Cln$Alrg(b){var a=this;a.Components$TemplateComponent(b);a.addEventListener("click",a._clickEvent);if(a.mode==="evisit"||a.mode==="echeckin"){a.Url=addQueryStringToUrl(a.Url,"localonly",1);a.DataFromMultipleSources=false}};$$WP.Clinical.Allergies.Components.Allergies.ParseAllergy=function $$WP$$Cln$Alrg$ParseAllergy(a){$$WP.Strings.setDefaultNamespace("clinical.allergies");if(a.PatientFriendlyType&&a.PatientFriendlyType.Value)a.IconClassName="type_"+a.PatientFriendlyType.Value;else a.IconClassName="type_default";if(a.ReactionList)for(var d=$$WP.Strings.getForTemplate("reactiondelimiter"),b=0;b<a.ReactionList.length;b++){var c=a.ReactionList[b];if(b>0)a.ReactionsDisplay=a.ReactionsDisplay+d+c.Title;else a.ReactionsDisplay=c.Title}$$WP.Strings.clearDefaultNamespace()};$$WP.Clinical.Allergies.Components.Allergies.prototype={template:$$WP.Templates.Clinical.Allergies,Class:"",Url:makeLink("Clinical/Allergies/LoadListData"),DataFromMultipleSources:true,AreaName:"allergies",mode:"",parent:null,setData:function $$WP$Clinical$Allergies$setData(a){if(a.DataList){a=$$WP.Clinical.Common.UpdateStrings(a,"clinical.allergies",this.mode,1);a.UpdateDxrAccountLink=$$WP.CommunityUtilities.createUpdateOrganizationURL();this.Components$TemplateComponent$setData(a)}},html:function $$WP$Clinical$Allergies$html(b){var a=this;a.Components$TemplateComponent$html(b);if(a.$content.height()>0&&a.Data.DataList&&a.Data.DataList!==null){$$WP.Behaviors.matchRowHeights(a.$content,".cardlist > .card");a.$content.trigger("resize",{forceShrink:true});if(a.mode==="echeckin")$afe.select(".vb_navigation").addClass("show");else{$afe.select(".component[data-component-id='"+a.ComponentNumber+"']").parents(".haspersonalnotes").removeClass("hidepersonalnotes").addClass("componentsloaded");$afe.select(".personalnotessection.component").trigger("resize")}}a.parent&&typeof a.parent[0]._onComponentLoaded==="function"&&a.parent[0]._onComponentLoaded();$$WP.Utilities.UI.MatchColumnHeights()},_clickEvent:function $$WP$Clinical$Allergies$_clickEvent(n){var e=false,j="clinical.allergies",g=true,c=this;if(n){var a,h,i,o;o=n.dataId;if(!o)return g;a=$$WP.Clinical.Common.GetClickedObject(c.Data,n,j);if(!a)return g;a.UseNativeDatePicker=$$WP.Utilities.UI.IsMobile||WP.DOM.Browser.isMobile;a.ReactionsLabel=$$WP.Strings.getForTemplate("reactionslabel",j);if(a.action>2&&a.action<7){var q={SupressTitle:g,TitleText:"",IsCondensed:e,Class:o,ParentD:c};h=new $$WP.Clinical.Common.Components.DeletePopup(q);h.setData(a);h.addEventListener("click",c._detailsClick);i=new $$WPContain.Popup({Components:[h],TitleText:a.title,positioningFunction:$$WPContain.Positions.CenterInside,Class:"pocdefaultpopup ",Size:$$WPContain.Popup.SizeEnum.SMALL});i._goBack=function(){this.dispose()};h.show();i.show();c.PopupContainer=i}else{var d;if(a.action===1){var r={Namespace:j};d=new $$WP.Clinical.Allergies.Components.AllergiesLookup(r)}var p={SupressTitle:g,IsCondensed:e,ParentD:c};a.SelectableReactionList=c.Data.ReactionList;a.NumberOfReactions=c.Data.ReactionList.length;if(a.SelectableReactionList&&a.ReactionList)for(var f=0;f<a.SelectableReactionList.length;f++)for(var k=0;k<a.ReactionList.length;k++){a.SelectableReactionList[f].Selected=e;if(a.SelectableReactionList[f].Value===a.ReactionList[k].Value||a.SelectableReactionList[f].Title===a.ReactionList[k].Title){a.SelectableReactionList[f].Selected=g;break}}var b=new $$WP.Clinical.Common.Components.ClinicalDetailsPopup(p);b.setData(a);b.addEventListener("click",c._detailsClick);b.addEventListener("submit",function(){return e});var l;if(a.action===1)l=[d,b];else l=[b];var m=new $$WPContain.Popup({Components:l,TitleText:a.title,Class:"lookupcontainer",positioningFunction:$$WPContain.Positions.InsideNearTop,Size:$$WPContain.Popup.SizeEnum.MEDIUM,SupportAnimations:e,BackButtonText:$$WP.Strings.get("popup_cancelbutton_label",j)});d.selectedResult=function(c){a.selectedId=c.ID;a.selectedName=c.Name;b.setData(a);b.refresh();b.show()};d.startOver=function(){b.hide();this.Components$LookupComponent$startOver()};m._goBack=function(){if(d)d.startOver();else this.dispose()};m.show();if(a.action===1){d.load();d.show()}else b.show();c.PopupContainer=m}return e}},_detailsClick:function $$WP$$Cln$$Alg$$Details$_click(s){var k=true,c=this;if(!s)return k;var t=s.dataId,x=s.$target.closest(".button"),v=$afe.jq(x),e=v.safeAttr("index"),a,d,i="";if(!t)return k;else if(t==="cancelitem")c.ContainerComponent._goBack();else{var l,m,f,j,n=c.$content.find("#datepicker");if(n.length>0){if(n.hasClass("nativeCalendar"))j=$$WP.I18N.formatPatientGivenDate(WP.Utils.iso2date(n.val()));else j=n.val();if(j.length>0){m="";if(IsDateValid(j,4,null,null,null))m=j;else return k}l=c.$content.find("#updatecomments");i=l.val();f="";for(var r=c.$content.find("#allergyselect :checked"),p=0;p<r.length;p++)if(f==="")f=r[p].value;else f+=","+r[p].value}switch(t){case"addeditem":a={};a.BaseID=e;a.Name=v.safeAttr("record-name");d=1;break;case"editeditem":a=c.ParentD.Data.currentList[e];d=2;break;case"editededititem":a=c.ParentD.Data.pendingEditList[e];d=2;break;case"editedadditem":a=c.ParentD.Data.pendingAddList[e];d=2;break;case"deleteditem":l=c.$content.find("#deletecomments");i=l.val();a=c.ParentD.Data.currentList[e];d=3;break;case"unaddeditem":a=c.ParentD.Data.pendingAddList[e];d=4;break;case"undeleteditem":a=c.ParentD.Data.pendingDeleteList[e];d=5;break;case"unediteditem":a=c.ParentD.Data.pendingEditList[e];d=6;break;default:return k}c.$content.find(".button").addClass("disabled");var w=c.ParentD,u=function(a){$$WP.Clinical.Common.handleAJAXResponse(a,"clinical.allergies",this)},b="action="+d,o="";if(a.DisplayObject&&a.DisplayObject.Name)o=a.DisplayObject.Name;else if(a.Name)o=a.Name;if(o!=="")b=b+"&name="+encodeURIComponent(o);if(i&&i!=="")b=b+"&comments="+encodeURIComponent(i.trim());if(a.DisplayObject&&a.DisplayObject.ID)b=b+"&id="+a.DisplayObject.ID;if(m)b=b+"&date="+m;if(f)b=b+"&reactionvals="+f;if(a.DisplayObject&&a.DisplayObject.UpdateInformation&&a.DisplayObject.UpdateInformation.ReferenceID)b=b+"&referenceID="+encodeURIComponent(a.DisplayObject.UpdateInformation.ReferenceID);if(a.BaseID)b=b+"&elgID="+a.BaseID;if(a.ShowExternalItems&&a.ExternalItems&&a.ExternalItems.length>0){for(var g="",h="",q=0;q<a.ExternalItems.length;q++){if(g.length>0){g=g+"^";h=h+"^"}g=g+a.ExternalItems[q].Organization.OrganizationId;h=h+a.ExternalItems[q].ID}b=b+"&externalMembers="+g+"&externalIDs="+h}$.ajax({url:makeLink("Clinical/Allergies/SubmitUpdate"),context:w,type:"POST",data:b,error:u,success:u})}return false}};$$WP.Clinical.Allergies.Components.Allergies.extend("Components.TemplateComponent")