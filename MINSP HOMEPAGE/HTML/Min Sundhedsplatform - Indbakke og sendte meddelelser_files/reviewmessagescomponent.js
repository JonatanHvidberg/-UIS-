/*! Copyright (c) Epic Systems Corporation 2019 */
$$WPUtil.guaranteeExistence($$WP,"Messaging");$$WP.Messaging.ReviewMessagesComponent=function MessageListHeaderComponent(b){var a=this;a.Components$CommunityListManagerComponent(b);if(!a.Mailbox)a.Mailbox="1";a.addEventListener("mousedown",a._mouseDown);a.addEventListener("keyup",a.keyup);a.addEventListener("click",a.click);a.$container.throttledTransitionEnd("li",$$WP.Utilities.UI.MatchColumnHeights,"min-height");a.windowHeight=$afe.jq(window).height();a._autoShowMessage=$$WPUtil.queryString("emid")||""};$$WP.Messaging.ReviewMessagesComponent.prototype={template:$$WP.Templates.Messaging.MessageList,AreaName:"MessageList",StringsNamespace:"Messaging.Review",SupportAnimations:false,Url:makeLink("Messaging/Review/GetPageSet?"),IsClosable:false,TitleText:null,Class:"messages",Mailbox:"1",dispose:function(a){return this.Components$CommunityListManagerComponent$dispose(a)},_getListHtml:function(f){var c=this,a,d=c._autoShowMessage,g=c.$content,h=function(){g.find("ul li.expanded").each(function(){var a=$afe.jq(this);a.css("min-height",a.contentHeight()+15+"px");window.setTimeout(function(){$afe.select("html, body").animate({scrollTop:a.offset().top})},300)})},b=f||c.RenderedData||[],e;d=d||"";if(d.length>0&&b.length>0)for(a=0;a<b.length;a++)if(unescape(b[a].Id)===d||b[a].Id===d){b[a].IsOpened=true;window.setTimeout(h,200);break}e=c.Components$CommunityListManagerComponent$_getListHtml(f,{Mailbox:c.Mailbox});return e},html:function(b,a){this.Components$CommunityListManagerComponent$html(b,a);this.$content.find("li.collapsed a.popupinstructionsicon").safeAttr("tabindex","-1")},load:function(){this.Components$CommunityListManagerComponent$load("emid="+this._autoShowMessage+"&mailbox="+this.Mailbox)},_updateHeaderFooter:function(){var a=this,c=a.$content.find("ul"),b=c.children("li.Unread"),g=b.filter(".CanMark").length>0&&parseInt(a.Mailbox,10)===1&&a.RenderedData.length>0,f=a.Mailbox==="1"&&b.length>0&&a.RenderedData.length>0,e=c.children("li.IncompleTasks").length>0&&a.RenderedData.length>0,d=a.Mailbox==="2"&&b.length>0&&a.RenderedData.length>0;a.Components$CommunityListManagerComponent$_updateHeaderFooter({CanMarkSome:g,HasUnfinishedTask:e,HasUnreadMessages:f,UndeleteCount:a.Data.UndeleteCount,Mailbox:a.Mailbox,ClinicHasUnreadMessages:d})},setData:function(a){if(a==="ALLITEMSDISPLAYED"){this._waiting=false;return}a.ViewBagProperties=a.ViewBagProperties||{};a.ViewBagProperties.CanMarkAsRead=JSON.parse(a.ViewBagProperties.CanMarkAsRead||"{}");for(var b in a.Organizations)a.Organizations[b].CanMarkAsRead=a.ViewBagProperties.CanMarkAsRead[b]==="1";delete a.ViewBagProperties.CanMarkAsRead;a.ViewBagProperties.UndeleteCount=parseInt(a.ViewBagProperties.UndeleteCount,10)||0;return this.Components$CommunityListManagerComponent$setData(a)},focusOn:function(c){var b=this.$container.find("ul.MessageList > li[data-index='"+c+"'] .row.message_header"),a=b[0];if(document.activeElement===a){b.blur();window.setTimeout(this._focusOnCallback,200,a)}else{b.focus();document.activeElement!==a&&window.setTimeout(this._focusOnCallback,200,a)}},collapseExpanded:function(){this.$content.find(".expanded").addClass("collapsed").addClass("noprint").removeClass("expanded").safeAttr("aria-expanded","false");this.$content.trigger("resize");this.$content.find("a.popupinstructionsicon").safeAttr("tabindex","-1")},keyup:function keyup(a){if(a.dataId==="toggle"&&a.keyCode===13)return this.click(a)},click:function click(a){var E="&viewqnr=-1",D="data-attachmentIndex",C="&attachmentIndex=",B="Messaging/Review/GetAttachment?messageId=",r="netredirect",A="&attachment=",z="Messaging/Review/SmartTextAttachment?co=true&id=",y="&throttleInfo=",j="&task=",x="JustRead",q="min-height",w="aria-expanded",p="noprint",v="expanded",m="collapsed",u="viewattachment",t="remoteAttachment",l="data-index",e=false,c=this,G,s,g,k,b,o,H,i,n,I;if(c._isMouseDown){c._isMouseDown=e;G=Math.sqrt(Math.pow(c._mouseDownX-a.clientX,2)+Math.pow(c._mouseDownY-a.clientY,2));s=new Date-c._mouseDownTime;if(s>1e3||G>10||a.shiftKey)return}if(a.dataId==="ignore"||!a.dataId||a.dataId==="redirect")return;if(a.$dataId.safeAttr("data-ischildindex")==="1"){g=a.$dataId.closest("li[data-index]").safeAttr(l);k=a.$dataId.safeAttr(l)}else if(a.dataId===t||a.dataId===u)g=a.$dataId.closest("li.SingleMessage[data-index]").safeAttr(l);else g=a.$dataId.safeAttr(l);b=c.RenderedData[g];if(!b)return;o=b.Id;c._lastSelectedIndex=g;i=b.Organization.IsLocal;switch(a.dataId){case"toggle":var F=a.$dataId.find(".row[role='button']");if(b.IncludesDetails){n=a.$dataId.hasClass(m);a.$dataId.toggleClass(m);a.$dataId.toggleClass(v);a.$dataId.toggleClass(p);F.safeAttr(w,n.toString());if(a.$dataId.inlineStyle(q)===""){a.$dataId.css(q,"0px");a.$dataId.css(q,a.$dataId.contentHeight()+"px")}c.$content.trigger("resize",{forceShrink:n});a.$dataId.find("a.popupinstructionsicon").safeAttr("tabindex",n?"":"-1")}else{a.$dataId.addClass("waiting");if(!a.$dataId.hasClass(m)){a.$dataId.addClass(m);a.$dataId.addClass(p);a.$dataId.removeClass(v);F.safeAttr(w,"false")}else a.$dataId.removeClass(p);!a.$dataId.hasClass(x)&&c.Mailbox==="1"&&a.$dataId.hasClass("Unread")&&a.$dataId.addClass(x);c._reloadIndex(g)}c.$content.trigger("resize");$afe.jq(window).trigger("matchColumnHeights");return e;case"replyto":if(i)$$WPUtil.TryRedirect(makeLink("inside.asp?mode=messages&action=reply&emid="+o));else $$WP.CommunityUtilities.openDeepLink("messages",b.Organization,{action:"reply",emid:encodeURIComponent(b.CommunityId)});return e;case"delete":c._removeRow(a.$dataId.closest("li"));c.Data.UndeleteCount++;c._updateHeaderFooter();c.makeRequest({type:"POST",dataType:"text",success:function(){},url:makeLink("Messaging/ReviewSynchronous/DeleteMessage?deleteIds=")+o+"&organizationId="+encodeURIComponent(b.Organization.OrganizationId)+"&mailbox="+c.Mailbox},"getmessagedetails",e,g);return e;case"dotask":var d="",f=b.Tasks[k];switch(f.TaskType){case 1:d="inside.asp?mode=msgapptmake&action=schmsgappt&emid="+encodeURIComponent(b.CommunityId)+j+f.TaskNumber+"&workflow=ticket&ticketId="+encodeURIComponent(f.TicketId);break;case 2:d="inside.asp?mode=questionnaire&emid="+encodeURIComponent(b.CommunityId)+y+encodeURIComponent(f.ThrottleInfo)+j+f.TaskNumber;break;case 3:d="inside.asp?mode=histques&emid="+encodeURIComponent(b.CommunityId)+j+f.TaskNumber+y+encodeURIComponent(f.ThrottleInfo)}if(i)$$WPUtil.TryRedirect(makeLink(d));else $$WP.CommunityUtilities.openDeepLinkUrl(d,b.Organization,null,c._reloadIndex,c);return e;case"printmessage":$$WPUtil.PrintAndAuditNET();return e;case"viewsmarttext":if(i)openWindow(makeLink(z+o+A+k));else $$WP.CommunityUtilities.openDeepLink(r,b.Organization,{targetUrl:z+encodeURIComponent(b.CommunityId)+A+k},$$WP.CommunityUtilities.openDeepLinkType.InNewTab);return e;case u:if(!i){d=B+encodeURIComponent(b.CommunityId)+C+a.$dataId.safeAttr(D);$$WP.CommunityUtilities.openDeepLink(r,b.Organization,{targetUrl:d},$$WP.CommunityUtilities.openDeepLinkType.InNewTab)}else{var h=new $$WP.Documents.ViewDocument.Models.DocumentModel(null,{},encodeURIComponent(a.$dataId.safeAttr("data-file")),encodeURIComponent(a.$dataId.safeAttr("data-dcsId")),a.$dataId.safeAttr("data-filename"),a.$dataId.safeAttr("data-extension"));if(a.$dataId.safeAttr("data-notiffpreview")==="1"&&(h.DocExt=="TIF"||h.DocExt=="TIFF"))h.AllowPreview=e;h.openAsPopup("messageAttachment sm-autosizedpopup");$afe.select(".messageAttachment .printIcon").click($.proxy(h.PrintClicked,h))}return e;case"printtask":d="";f=b.Tasks[k];switch(f.TaskType){case 1:return e;case 2:d="inside.asp?mode=questionnaire&printmode=true&emid="+encodeURIComponent(b.CommunityId)+j+f.TaskNumber+E;break;case 3:d="inside.asp?mode=histques&printmode=true&emid="+encodeURIComponent(b.CommunityId)+j+f.TaskNumber+E}if(i)openWindow(makeLink(d));else $$WP.CommunityUtilities.openDeepLinkUrl(d,b.Organization,$$WP.CommunityUtilities.openDeepLinkType.InNewWindow);return e;case t:d=B+encodeURIComponent(b.CommunityId)+C+a.$dataId.safeAttr(D);$$WP.CommunityUtilities.openDeepLink(r,b.Organization,{targetUrl:d},$$WP.CommunityUtilities.openDeepLinkType.InNewTab);return e}},onDetailsFail:function(b,a){this.RenderedData[a].Body=$$WP.Strings.get("WidgetErrorMessage");this._refreshIndex(a);$afe.jq(window).trigger("matchColumnHeights")},_reloadIndex:function(b){var a=this;a._dontAutoExpand=a._dontAutoExpand||{};if(isNaN(b)){b=a._lastSelectedIndex;a._dontAutoExpand[b]=true}var c=a.RenderedData[b],d=a.$content.find("ul").children("li[data-index='"+b+"']").get(0);a.makeRequest({type:"POST",dataType:"json",success:a.setDetails,failure:a.onDetailsFail,url:makeLink("Messaging/Review/MessageDetails?id=")+c.Id+"&organizationId="+encodeURIComponent(c.Organization.OrganizationId)+"&mailbox="+a.Mailbox},"getmessagedetails",false,parseInt(b,10))},_refreshIndex:function(e,g){var c="collapsed",f="min-height",b=this,d=b.$content.find("ul").children("li[data-index='"+e+"']"),h=b.template({List:[b.RenderedData[e]],UserPhoto:b.UserPhoto,ListOffset:e,PhotoColor:b.PhotoColor,Mailbox:b.Mailbox,ComponentNumber:b.ComponentNumber,HeaderComponentNumber:b.ContainerComponent.HeaderComponent.ComponentNumber}).trim(),a=dangerou$.parseHtml(h).children("li");$$WPUtil.removePopupListener(d);a.safeInsertAfter(d);a.removeClass("hidden");a.css(f,a.contentHeight()+"px");d.remove();b.SearchString&&$$WPUtil.highlightNodeText(a.get(0),b.SearchString);$$WPUtil.addPopupListener(a);b.$content.trigger("resize");var i=a.removeClass(c).contentHeight();if(g){a.addClass(c);a.addClass("noprint")}else{a.removeClass(c);a.removeClass("noprint");a.addClass("expanded");a.find(".row[role='button']").safeAttr("aria-expanded","true")}a.css(f,i+"px");return a},setDetails:function(b,c){var a=this,d;b.PrimaryDate=new Date(b.PrimaryDate);b.Organization=a.RenderedData[c].Organization;b.Id=encodeURIComponent(b.Id);b.CommunityIdUrlEncoded=encodeURIComponent(b.CommunityId);a.RenderedData[c]=b;d=a._refreshIndex(c,a._dontAutoExpand[c]);if(a._dontAutoExpand[c]!==true)a.focusOn(c);else a._dontAutoExpand[c]=null;$$WPUtil.AddPopupListener(a.$container);$afe.jq(window).trigger("matchColumnHeights")},_mouseDown:function _mouseDown(b){var a=this;a._isMouseDown=true;a._mouseDownTime=new Date;a._mouseDownX=b.clientX;a._mouseDownY=b.clientY},_removeRow:function _removeRow(a){a.safeAttr("data-id","ignore").addClass("deleted").safeAttr("aria-live","polite").safeAttr("tabindex","-1").safeAttr("role","presentation").focus();a.empty().safeAppend($$WP.SimpleTemplates.Span({"class":"clearlabel"}).text($$WP.Strings.get("MessageDeletedLabel","Messaging.Review")));a.blur(function(){setTimeout(function(){a.empty().removeAttr("aria-expanded").removeAttr("role")})})},shouldBeFiltered:function(a){var b=this.ContainerComponent.HeaderComponent.Data;return b.UnreadMessagesFilter&&a.WasRead?true:b.UnfinishedTasksFilter&&!a.HasIncompleteTask?true:this.Components$CommunityListManagerComponent$shouldBeFiltered(a)}};$$WP.Messaging.ReviewMessagesComponent.extend("Components.CommunityListManagerComponent")