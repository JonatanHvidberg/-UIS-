/*! Copyright (c) Epic Systems Corporation 2018-2019 */
$$WPUtil.guaranteeExistence($$WP,"Clinical.TestResultsPOC.Components");$$WP.Clinical.TestResultsPOC.Components.TRPComponent=function $$WP$Clinical$TestResultsPOC$Components$TRPComponent(b){var c="Clinical.TestResults",a=this;a.RegistryID=b.RegistryID||"";a.RegistryName=b.RegistryName||"";a.IsRegistryFilterActive=a.RegistryID!=="";a.componentCardLimit=b.componentCardLimit||100;if(a.IsRegistryFilterActive)a.TitleText=$$WP.Strings.getForTemplate("LatestResults",c);else a.TitleText=$$WP.Strings.getForTemplate("Title",c);a.Components$TemplateComponent(b);a.$container.css("height","100%");if(a.IsRegistryFilterActive){a._baseUrl=makeLink("Clinical/TestResults/GetRegistryResults?registryID="+a.RegistryID);a.AlwaysShowViewMore=false;a.Url=a.generateUrl()}else{var d=$$WPUtil.queryString("filterinpatient")==="1"||$$WPUtil.queryString("rslt_toggle")==="0"?"1":"0";a._baseUrl=makeLink("Clinical/TestResults/GetPageSet?localOnly=true&includeComponents=true&filterIPURL="+d);a.Url=a._baseUrl}a.addEventListener("click",a._resultsClick);a.addEventListener("keyup",a._resultsKeyup)};$$WP.Clinical.TestResultsPOC.Components.TRPComponent.prototype={Class:"pocdefault withborder TRPSmall",template:$$WP.Templates.Clinical.TRPList,Url:null,ShowPocExpandIcon:true,AlwaysShowExpandIcon:true,AlwaysShowViewMore:false,RegistryID:"",RegistryName:"",IsRegistryFilterActive:false,FilterInpatient:"1",SearchString:"",InitialData:null,_tableComp:null,_detailsComp:null,_components:null,_hasRegenerateGraphEvent:false,_lastFocusedElement:null,generateUrl:function $$WP$Cln$TRPComp$generateUrl(){var a=this,b=a._baseUrl;if(!a.IsRegistryFilterActive)b+="&filterInpatient="+a.FilterInpatient+"&searchString="+a.SearchString;return b},setData:function $$WP$Cln$TRPComp$setData(b){var d=true,a=this,e;a.$container.removeClass("noinfo");if(a.IsRegistryFilterActive){if($.isArray(b))if(b.length===0){e=a._noData();a.Components$TemplateComponent$setData(e)}else{b=a._dataTransform(b,d);b.IsRegistryFilterActive=a.IsRegistryFilterActive;b.RootInfo={IsRegistryFilterActive:a.IsRegistryFilterActive};a.InitialData=$.extend(d,{},b);a.AlwaysShowViewMore=false;a.Components$TemplateComponent$setData(b);a.$container.find("a.viewmore").addClass("registryViewMore");a._components=b.Components;a.generateBarGraphs(b.Components);a._setupResizeEvents(b.Components);$afe.select(".testresultspoc.matchHeights").each($$WP.Utilities.UI.Cards.MatchHeights)}}else if(b.List){a.InitialData=$.extend(d,{},b);var f=false,g=b.List;a.FilterInpatient=b.ViewBagProperties.IPFiltered;for(var h in g){var c=g[h].List;a.AlwaysShowViewMore=d;if(c.length>0){c=a._dataTransform(c,false,a.FilterInpatient,b.ViewBagProperties,a.SearchString);c.IsRegistryFilterActive=a.IsRegistryFilterActive;a._getViewMoreButton().remove();a.Components$TemplateComponent$setData(c);a._components=c.Components;a.generateBarGraphs(c.Components);a._setupResizeEvents(c.Components);f=d}$afe.select(".testresultspoc .timeLineSection .matchHeights").each($$WP.Utilities.UI.Cards.MatchHeights);break}if(!f){e=a._noData(b.ViewBagProperties.HasIPEncounter);a.Components$TemplateComponent$setData(e)}!$$WPUtil.IsNullOrEmpty(a.SearchString)&&f&&$$WPUtil.highlightNodeText(a.$content.find(".timeLine")[0],a.SearchString)}$afe.jq(window).trigger("matchColumnHeights");a.$container.css("height","100%")},html:function(b){var a=this;a.Components$TemplateComponent$html(b);if(a._lastFocusedElement){a.$content.find(a._lastFocusedElement).focus();a._lastFocusedElement=null}},_noData:function $$WP$Cln$TRPComp$_noData(b){var a=this;a.ShowPocExpandIcon=false;a.AlwaysShowExpandIcon=false;a.AlwaysShowViewMore=false;a.$container.addClass("noinfo");return{HasNoData:true,IsRegistryFilterActive:a.IsRegistryFilterActive,RegistryName:a.RegistryName,FilterInpatient:a.FilterInpatient,HasIPEncounter:b,HasSearch:!$$WPUtil.IsNullOrEmpty(a.SearchString),SearchString:a.SearchString}},generateBarGraphs:function $$WP$Cln$TRPComp$generateBarGraphs(j,f){var d="trpHidden",h=".tr_poc_graph_cell",e,a,b,c,i,l,k;if(!$afe.select(h).length)return;k=f?f:$afe.select(h).width();l=Math.round(k*.8);for(var m in j){a=j[m];if(!a.shouldRenderOnClient)continue;b=$afe.select("#trpGraph_"+a.clientOnlyID);c=$afe.select("#trpTable_"+a.clientOnlyID);i=$afe.select("#trpRefRange_"+a.clientOnlyID);e=false;var g=a.DisplayLow.length+a.DisplayHigh.length<=16,q=a.Low!==null&&a.High!==null&&a.NumericValue!==null,p=a.Low<a.High,n=this._isComponentFlagAbnormal(a.AbnormalFlagCategoryValue),o=$$WPTestResultsUtil.GetAriaReferenceRange(a);if(q&&p){b.empty();e=$$WP.Clinical.TestResultsPOC.Components.RefObj.prototype.CreateRefObj({width:l,height:3,min:a.Low,val:a.NumericValue,max:a.High,dispMin:a.DisplayLow,dispMax:a.DisplayHigh,dispVal:a.Value,showRefRangeValues:g,unit:a.Units,key:m,target:b,referenceRange:a.ReferenceRange,ariaReferenceRange:o})}if(e){b.removeClass(d);!g&&i.removeClass(d);c.empty();n&&b.find(".markerText").addClass("abnormal");this._fixAlignText(b)}else{c.closest(".componentDataTable").addClass("tableData");c.removeClass(d)}}},_fixAlignText:function $$WP$Cln$TRPComp$_fixAlignText(f){var c,b,a,e,d;c=f.find(".markerText");b=c[0].getBBox().width;a=parseFloat(c.safeAttr("x"));e=f.width();if(a+b/2>e){d=a+b/2-e;c.safeAttr("x",a-d)}else if(a-b/2<0){d=-(a-b/2);c.safeAttr("x",a+d)}},_resultsClick:function $$WP$Cln$TRPComp$_resultsClick(c){var b="Clinical.TestResults",e="@MYCHART@CONDITION@",d="viewmore",a=this;switch(c.dataId){case"selectli":case"selectlianchor":case"selectti":case"selectda":case $$WPComp.TITLEBARIDENTIFIER+d:case d:var f=a.TitleText;if(a.IsRegistryFilterActive){$$WP.Strings.addMnemonic(e,a.RegistryName,false,b);f=$$WP.Strings.getForTemplate("Title_Condition",b);$$WP.Strings.removeMnemonic(e,b)}a._openGraphPopup(c,f);break;case"search":if($$WPUtil.IsNullOrEmpty(a.SearchString))a._updateSearch(a.$content.find("input.SearchList").val());else a._updateSearch("");break;case"toggleWrapper":case"toggleLabel":case"toggleinpatient":a.$content.empty();a._getViewMoreButton().hide();if(a.FilterInpatient==="1"){a.FilterInpatient="0";c.$dataId.prop("title",$$WP.Strings.get("HideHospitalResults",b))}else if(a.FilterInpatient==="0"){a.FilterInpatient="1";c.$dataId.prop("title",$$WP.Strings.get("ShowHospitalResults",b))}a.Url=a.generateUrl();a.load();break;case undefined:return true}return false},_resultsKeyup:function $$WP$Cln$TRPComp$_resultsKeyup(a){var b=13,d=27,c=32;switch(a.dataId){case"searchlist":if(a.keyCode===b){if(a.$target.safeAttr("name").toLowerCase().indexOf("search")>-1){this._updateSearch(a.$target.val());return false}}else if(a.keyCode===d){this._updateSearch("");return false}break;case"toggleWrapper":(a.keyCode===b||a.keyCode===c)&&a.$target.find("input").click();break;case"selectda":if(a.keyCode===b){this._resultsClick(a);return false}}return true},_updateSearch:function _updateSearch(b){var a=this;b=b.trim();if(b===a.SearchString)return;a.SearchString=b;a.$content.empty();a._getViewMoreButton().hide();a.Url=a.generateUrl();a.load();a._lastFocusedElement="input.SearchList"},_openGraphPopup:function $$WP$Cln$TRPComp$_openGraphPopup(m,r){var o="data-index",c=true,a=this,i=[],b,l,j,f,e;b=new $$WP.Clinical.TestResultsPOC.Components.TRPContainer({RegistryID:a.RegistryID,FilterInpatient:a.FilterInpatient,SearchString:a.SearchString,IsRegistryFilterActive:a.IsRegistryFilterActive,DataFromMultipleSources:false,Class:"leftcolumn column",showSelectedComponentGraph:$.proxy(a._showSelectedComponentGraph,a),showSelectedTestResult:$.proxy(a._showSelectedTestResult,a),dataTransform:$.proxy(a._dataTransform,a),baseUrl:a._baseUrl});b.ListComponent.Components$CommunityListManagerComponent$clearModel();i.push(b);l=new $$WP.Clinical.TestResultsPOC.Components.TRPDetailsComponent({Class:"TRPTop TRPContent TRPDetails",resultsPopupComponentFocusIn:$.proxy(b._resultsPopupComponentFocusIn,b)});a._detailsComp=l;i.push(l);j=new $$WP.Clinical.TestResultsPOC.Components.TRPTableComponent({RegistryID:a.RegistryID,Class:"TRPTop TRPContent rightcolumn column",showSelectedTestResult:$.proxy(a._showSelectedTestResult,a)});a._tableComp=j;i.push(j);f=new $$WPContain.Popup({Class:"goalslarge trlarge pocdefaultpopup",TitleText:r,Size:$$WP.Containers.Popup.SizeEnum.LARGE,IsClosable:c,Components:i,positioningFunction:$$WPContain.Positions.InsideNearTop});b.ListComponent.setData($.extend(c,{},a.InitialData));b.show(c);j.show();if(a.Data.CanAccessDetails&&!a._isTestResultsListPage()){e=new $$WP.Clinical.TestResultsPOC.Components.TRPDisclaimer({Class:"TRPDisclaimer",resultsPopupComponentFocusIn:$.proxy(b._resultsPopupComponentFocusIn,b)});b.ListComponent.ContainerComponent.addComponent(e);b.DisclaimerComponent=e;e.show()}f.show();e&&e.resizeBox();var d=m.$target.closest(".TRPComponent");if(d&&d.length===1){f.OpenedWith="Card";var q=d.safeAttr(o);a._showSelectedComponentGraph(q,c)}else{d=m.$target.closest(".TRPComponentHeader");if(d&&d.length===1){f.OpenedWith="Card";var p=d.safeAttr(o);a._showSelectedTestResult(p,c)}else{f.OpenedWith="ViewMore";if(a.IsRegistryFilterActive){var k=a.Data.Components[0];k&&a._showSelectedComponentGraph(k.OrderID+"_"+k.clientOnlyID)}else{var h,g,n;h=a.Data.TestResultTimeline;if(h&&h[0]){g=h[0];if(g.testResults&&g.testResults[0]){n=g.testResults[0];a._showSelectedTestResult(n.Key,c)}}m.$target.closest(".viewmore").is(a._getViewMoreButton())&&a._scrollPopup($afe.select('.trlarge span[data-id="loadmore"]'),c,$afe.select(".TRPContainer.TRPTop > .content")[0].scrollHeight)}}}},_getComponent:function $$WP$Cln$TRPComp$_getComponent(a){return $afe.select('.TRPComponentAbbrev[data-index="'+a+'"]')},_getTestResult:function $$WP$Cln$TRPComp$_getTestResult(a){return $afe.select('li.TRPComponentAbbrev[data-index="'+a+'"]')},_isTestResultsListPage:function _isTestResultListPage(){return $afe.select("#main").find(".TestResults.template").length},_scrollPopup:function $$WP$Cln$TRPComp$_scrollPopup(a,d,b){if(d&&a&&a.length){var c=$afe.select(".TRPContainer.TRPTop > .content");if(typeof b==="undefined")b=a.position().top-c.height()/2+a.height();c.animate({scrollTop:b},0)}},_showSelectedComponentGraph:function $$WP$Cln$TRPComp$_showSelectedComponentGraph(h,i){var g="selected",a=this,d,b,c,f;if(h){a._detailsComp.hide();$afe.select(".testresultspoc .selected").removeClass(g);b=a._getComponent(h);if(b.length){d=b.safeAttr("compid");b.addClass(g);a._scrollPopup(b,i);if(a.IsRegistryFilterActive){var e=a.Data.orig[d];e&&a._tableComp.setData(e)}else{c=b.safeAttr("orderid");f=$afe.jq(b[0].parentElement.firstElementChild).safeAttr("data-index");c&&a._tableComp.setComponentId(d,c,f)}}a._tableComp.show()}},_markTestResultAsRead:function $$WP$Cln$TRPComp$_markTestResultAsRead(g){var c=this;for(var d,e,a=0;a<c.Data.TestResultTimeline.length;a++)for(d=0;d<c.Data.TestResultTimeline[a].testResults.length;d++){e=c.Data.TestResultTimeline[a].testResults[d];if(e.Key===g)e.ReadStatus=0}var f=c.InitialData.List;for(var h in f)if(f.hasOwnProperty(h)){var b=f[h].List;for(a=0;a<b.length;a++)if(b[a].Key===g){if(b[a].ReadStatus===2)b[a].wasOriginallyUpdated=true;b[a].ReadStatus=0}}},_showSelectedTestResult:function $$WP$Cln$TRPComp$_showSelectedTestResult(c,j){var e="Read",g="selected",a=this;$afe.select(".testresultspoc .selected").removeClass(g).filter(".TRPComponentHeader").addClass(e);var b=$afe.select("li.SingleResult[data-index='"+c+"']");if(!b.hasClass(e)){b.addClass(e);var h=b.find(".CommentIcon");h.length&&h.safeAttr("src",makeStaticLink("images/test_results/comments_read.svg"));var i=b.find("img.ListIcon"),d=i.safeAttr("src");d=d.replace("_unread","_read");i.safeAttr("src",d)}a._markTestResultAsRead(c);var f=a._getTestResult(c);if(f.length){f.addClass(g);a._scrollPopup(f,j)}a._tableComp.hide();a._detailsComp.load(makeLink("inside.asp?mode=labdetail&eorderid="+c+"&co=true"))},_dataTransform:function $$WP$Cln$TRPComp$_dataTransform(f,h,j,i,g){var c=this,a,b=[],e;if(h){a=c._registryTransformHelper(f);e=a[0]&&a[0].canAccessDetails}else{a={};b=c._transformHelper(f,a);e=true;for(var d=0;d<b.length;d++){b[d].testResults.sort(c._componentCountSortFunc);c._addRenderProperties(b[d])}}return{TestResultTimeline:b,Components:a,ViewBagProperties:i,FilterInpatient:j,CanAccessDetails:e,HasSearch:!$$WPUtil.IsNullOrEmpty(g),SearchString:g,orig:f}},_transformHelper:function $$WP$Cln$TRPComp$_transformHelper(i,k){for(var e={},d,b,h=0,f=0;f<i.length;f++){var a=i[f];a.wasOriginallyUpdated=a.wasOriginallyUpdated||a.ReadStatus===2;d=new Date(a.PrimaryDate);d.setHours(0,0,0,0);e[d]=e[d]||{testResults:[]};var c=e[d];if(c.testResults.length===0)c.shouldRenderOnClient=h<=this.componentCardLimit;c.testResults.push(a);c.PrimaryDate=a.PrimaryDate;c.FormattedDate=a.FormattedDate;c.FormattedShortDate=a.FormattedShortDate;c.FormattedDateFullMonth=a.FormattedDateFullMonth;c.FormattedShortDateFullMonth=a.FormattedShortDateFullMonth;c.year=d.getFullYear();if(a.Components){a.hasOnlyOneComponent=a.Components.length===1||a.Components.length===0;for(var g=0;g<a.Components.length;g++){b=a.Components[g];b.OrderID=a.Id;b.clientOnlyID=h++;k[b.clientOnlyID]=b;b.date=d;b.parent=a;b.shouldRenderOnClient=c.shouldRenderOnClient;b.IsAbnormal=this._isComponentFlagAbnormal(b.AbnormalFlagCategoryValue);b.AriaReferenceRange=$$WPTestResultsUtil.GetAriaReferenceRange(b)}if(a.Components.length>2&&a.Components.length%2!==0)a.needsBlankCard=true}}var j=Object.keys(e).map(function(a){return e[a]});return j},_registryTransformHelper:function $$WP$Cln$TRPComp$_registryTransformHelper(c){for(var e=[],f=0,b=0;b<c.length;b++){var d=c[b].HistoricalValues,a=d[d.length-1];a.Name=c[b].ComponentCommonName;a.clientOnlyID=f++;a.ComponentID=a.clientOnlyID;a.shouldRenderOnClient=true;a.canAccessDetails=c[b].CanAccessDetails;a.IsAbnormal=this._isComponentFlagAbnormal(a.AbnormalFlagCategoryValue);e.push(a)}return e},_componentCountSortFunc:function $$WP$Cln$TRPComp$_componentCountSortFunc(a,b){return a.Components.length===b.Components.length?a.Name<b.Name?-1:a.Name>b.Name?1:0:a.Components.length===0?1:b.Components.length===0?-1:a.Components.length<b.Components.length?-1:a.Components.length>b.Components.length?1:0},_addRenderProperties:function $$WP$Cln$TRPComp$_addRenderProperties(e){for(var d=e.testResults,a=0,c=0;c<d.length;c++){var b=d[c];if(b.hasOnlyOneComponent)a++;else a=0;if(b.hasOnlyOneComponent&&a%2===1)b.isLeftSideRender=true}},_getViewMoreButton:function _getViewMoreButton(){return this.$container.find("a.viewmore:not(.pocexpand)")},_setupResizeEvents:function _setupResizeEvents(){var a=this;if(!a._hasRegenerateGraphEvent){var b=function(){this.generateBarGraphs(this._components)};window.addEventListener&&window.addEventListener("resize",$.proxy(b,a),true);if(WP.DOM.Browser.isFirefox){var c=window.print,e=function(){var a=this;try{a.generateBarGraphs(a._components,180);c();a.generateBarGraphs(a._components)}catch(b){c()}};window.print=$.proxy(e,a)}else if(window.matchMedia){var d=window.matchMedia("print");d.addListener($.proxy(b,a))}a._hasRegenerateGraphEvent=true}},_isComponentFlagAbnormal:function _isComponentFlagAbnormal(a){return a===2||a===3}};$$WP.Clinical.TestResultsPOC.Components.TRPComponent.extend("Components.TemplateComponent")